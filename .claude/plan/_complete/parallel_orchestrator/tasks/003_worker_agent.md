# Task 003: Worker Agent

## Description

Create the worker agent configuration that runs in each worktree. The worker agent receives a task, implements it with TDD, creates a commit, and opens a PR. It updates Beads metadata as it progresses through each phase.

## Dependencies

- 001_initialize_beads - Beads must be set up first

## Success Criteria

1. Worker agent prompt defined in `.claude/agents/worker.md`
2. Agent updates Beads phase as it progresses
3. Agent follows TDD workflow
4. Agent creates properly formatted commit
5. Agent creates PR with correct metadata
6. Agent handles errors gracefully

## Implementation Steps

### 1. Create Agents Directory

```bash
mkdir -p .claude/agents
```

### 2. Create Worker Agent Prompt

Create `.claude/agents/worker.md`:

```markdown
# Worker Agent

You are a worker agent implementing task $TASK_ID in an isolated git worktree.

## Your Task

First, get the full task details:
```bash
bd show $TASK_ID
```

## Workflow

### Phase 1: Understanding
1. Read the task description from beads
2. Check for any linked spec files in `.plan/`
3. Understand the acceptance criteria

### Phase 2: Implementation (TDD)
1. Write failing tests first
2. Implement minimum code to pass
3. Refactor if needed
4. Update beads: `bd update $TASK_ID --meta phase=working`

### Phase 3: Verification
Run the project checks:
```bash
just check
```

If checks fail, fix issues before proceeding.

### Phase 4: Commit
Stage and commit your changes:
```bash
git add -A
git commit -m "feat: <description>

Implements $TASK_ID

Co-Authored-By: Claude <noreply@anthropic.com>"
```

Update beads:
```bash
bd update $TASK_ID --meta phase=committed
```

### Phase 5: Push and PR
Push your branch and create a PR:
```bash
git push -u origin HEAD

gh pr create \
  --title "feat: <short description>" \
  --body "$(cat <<'EOF'
## Summary
<1-3 bullet points describing what this PR does>

## Task
Implements $TASK_ID

## Test Plan
- [ ] Unit tests pass
- [ ] Integration tests pass
- [ ] `just check` passes

---
Generated by Worker Agent
EOF
)"
```

Record the PR number:
```bash
PR_NUM=$(gh pr view --json number -q .number)
bd update $TASK_ID --meta phase=pr_created --meta pr_number=$PR_NUM
```

## Rules

1. **Stay focused**: Only implement what the task requires
2. **No scope creep**: Don't fix unrelated issues you notice
3. **Update beads**: Always update phase metadata as you progress
4. **Test first**: Follow TDD - write tests before implementation
5. **Clean commits**: One logical commit per task
6. **Clear PRs**: PR description should explain what and why

## Error Handling

If you encounter an error you cannot resolve:
1. Document the error in the agent log
2. Do NOT update phase to committed if tests fail
3. The orchestrator will detect the stalled agent

## Completion

Your work is complete when:
- [ ] Task implemented according to spec
- [ ] All tests pass
- [ ] `just check` passes
- [ ] Changes committed
- [ ] PR created
- [ ] Beads updated with `phase=pr_created` and `pr_number`
```

### 3. Create Agent Loader Script

Create `scripts/run-worker.sh` for manual agent invocation:

```bash
#!/bin/bash
set -euo pipefail

TASK_ID=${1:?Usage: run-worker.sh <task-id>}
WORKTREE_BASE="../worktrees"
WORKTREE="${WORKTREE_BASE}/${TASK_ID}"
BRANCH="agent/${TASK_ID}"

# Verify task exists
bd show "$TASK_ID" > /dev/null || { echo "Task not found: $TASK_ID"; exit 1; }

# Create worktree if needed
if [ ! -d "$WORKTREE" ]; then
    git worktree add "$WORKTREE" -b "$BRANCH" 2>/dev/null || \
        git worktree add "$WORKTREE" "$BRANCH"
fi

# Update beads
bd update "$TASK_ID" \
    --status in_progress \
    --meta worktree="$WORKTREE" \
    --meta branch="$BRANCH" \
    --meta phase=spawned

# Run worker agent
cd "$WORKTREE"
PROMPT=$(cat .claude/agents/worker.md | sed "s/\\\$TASK_ID/$TASK_ID/g")
claude --print "$PROMPT"
```

## Test Cases

### Test 1: Agent Prompt Substitution
```bash
#!/bin/bash
# Verify $TASK_ID placeholder gets replaced
test_prompt=$(cat .claude/agents/worker.md | sed "s/\\\$TASK_ID/lt-test123/g")
echo "$test_prompt" | grep -q "lt-test123" || exit 1
echo "PASS: placeholder substitution"
```

### Test 2: Manual Worker Invocation
```bash
#!/bin/bash
# Create test task
task_id=$(bd create "Test worker" --json | jq -r '.id')

# Verify script starts (will fail without actual implementation, but should parse)
./scripts/run-worker.sh "$task_id" --help 2>&1 || true

# Cleanup
bd delete "$task_id" --force
echo "PASS: manual invocation"
```

## Verification Checklist

- [ ] `.claude/agents/worker.md` created
- [ ] Prompt includes all workflow phases
- [ ] Prompt references beads update commands
- [ ] `scripts/run-worker.sh` created and executable
- [ ] Placeholder substitution works correctly
- [ ] Agent prompt fits within context limits

## Notes

- The `$TASK_ID` placeholder is replaced by the orchestrator before invoking
- Agent should be idempotent - safe to restart mid-execution
- Consider adding timeout handling for long-running tasks
- The `--print` flag runs Claude non-interactively

## Files to Modify

- `.claude/agents/worker.md` - Create worker agent prompt
- `scripts/run-worker.sh` - Create manual runner script
